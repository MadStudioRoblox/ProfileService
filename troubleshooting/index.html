
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://madstudioroblox.github.io/ProfileService/troubleshooting/">
      
      
        <link rel="prev" href="../tutorial/developer_products/">
      
      
        <link rel="next" href="../api/">
      
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Troubleshooting - ProfileService</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="Deep-Purple" data-md-color-accent="Deep-Purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#problems-in-roblox-studio-testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ProfileService" class="md-header__button md-logo" aria-label="ProfileService" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ProfileService
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Troubleshooting
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/MadStudioRoblox/ProfileService" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    MadStudioRoblox/ProfileService
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ProfileService" class="md-nav__button md-logo" aria-label="ProfileService" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4Z"/></svg>

    </a>
    ProfileService
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/MadStudioRoblox/ProfileService" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    MadStudioRoblox/ProfileService
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/settingup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setting up
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/basic_usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/developer_products/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer Products
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problems-in-roblox-studio-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Problems in Roblox studio testing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-data-which-roblox-cannot-serialize" class="md-nav__link">
    <span class="md-ellipsis">
      Saving data which Roblox cannot serialize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#profiles-take-over-7-seconds-to-load" class="md-nav__link">
    <span class="md-ellipsis">
      Profiles take over 7 seconds to load
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datastore-warnings-caused-by-profileservice" class="md-nav__link">
    <span class="md-ellipsis">
      DataStore warnings caused by ProfileService
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problems-in-roblox-studio-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Problems in Roblox studio testing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saving-data-which-roblox-cannot-serialize" class="md-nav__link">
    <span class="md-ellipsis">
      Saving data which Roblox cannot serialize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#profiles-take-over-7-seconds-to-load" class="md-nav__link">
    <span class="md-ellipsis">
      Profiles take over 7 seconds to load
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datastore-warnings-caused-by-profileservice" class="md-nav__link">
    <span class="md-ellipsis">
      DataStore warnings caused by ProfileService
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Troubleshooting</h1>

<blockquote>
<p>Whether you're still writing your game code or already ran into a problem while using ProfileService, this page is a valuable resource for avoiding several crucial mistakes.</p>
</blockquote>
<h2 id="problems-in-roblox-studio-testing">Problems in Roblox studio testing</h2>
<p>By default, data saved with ProfileService in Roblox Studio will not persist. This can be changed by <a href="https://developer.roblox.com/en-us/articles/Data-store#using-data-stores-in-studio">enabling studio access to API services</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When studio access to API services is enabled, ProfileService will write to live DataStore keys of the game you're editing
(unless <a href="/ProfileService/api/#profilestoremock">ProfileStore.Mock</a> is used) and you might accidentally make unwanted changes to your game's saved data. For more info, check the <a href="https://developer.roblox.com/en-us/articles/Data-store#using-data-stores-in-studio">official documentation</a>.</p>
</div>
<h2 id="saving-data-which-roblox-cannot-serialize">Saving data which Roblox cannot serialize</h2>
<p>I've made the decision to opt-out <code>Profile.Data</code> and <code>Profile.MetaData.MetaTags</code> automatic checking
for unserializable data types for efficiency reasons. Consequently, you must be aware of what you
<strong>MUST AVOID</strong> writing inside <code>Profile.Data</code> or <code>Profile.MetaData.MetaTags</code>, directly and inside any nested tables:</p>
<ul>
<li><code>NaN</code> values - you can check if a number is <code>NaN</code> by comparing it with itself - <code>print(NaN == NaN) --&gt; false</code> (e.g., <code>Profile.Data = {Experience = 0/0}</code>). <code>NaN</code> values are a result of division by zero and edge cases of some math operations (<code>math.acos(2)</code> is <code>-NaN</code>).</li>
<li>Table keys that are neither strings nor numbers (e.g., <code>Profile.Data[game.Workspace] = true</code>).</li>
<li>Mixing string keys with number keys within the same table (e.g., <code>Profile.Data = {Coins = 100, [5] = "yes"}</code>).</li>
<li>Storing tables with non-sequential indexes (e.g., <code>Profile.Data = {[1] = "Apple", [2] = "Banana", [3546] = "Peanut"}</code>). If you really have to store non-sequential numbers as indexes, you will have to turn those numbers into <code>string</code> indexes: <code>Profile.Data.Friends[tostring(user_id)] = {GoodFriend = true}</code>.</li>
<li>Storing cyclic tables (e.g., <code>Profile.Data = {Self = Profile.Data}</code>).</li>
<li>Storing any <code>userdata</code> including <code>Instance</code>, <code>Vector3</code>, <code>CFrame</code>, <code>Udim2</code>, etc. Check whether your value is a <code>userdata</code> by running <code>print(type(value) == "userdata")</code> (e.g., <code>Profile.Data = {LastPosition = Vector3.new(0, 0, 0)}</code>) - For storage, you will have to manually convert your <code>userdata</code> to tables, numbers and strings for storage (e.g., <code>Profile.Data = {LastPosition = {position.X, position.Y, position.Z} }</code>).</li>
</ul>
<p>This is a limitation of the <a href="https://developer.roblox.com/en-us/articles/Datastore-Errors">DataStore API</a> which ProfileService is based on.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Failure to prevent these data types may result in silent data loss, silent errors, fatal errors and overall failure to save data.</p>
</div>
<h2 id="profiles-take-over-7-seconds-to-load">Profiles take over 7 seconds to load</h2>
<div class="admonition notice">
<p class="admonition-title">Notice</p>
<div class="highlight"><pre><span></span><code>Due to technical limitations, it&#39;s expected that at least 5% of the time, when the player hops servers rapidly, the profile
can take up to 7 seconds to load (Can be greatly improved by using [Profile:ListenToHopReady()](/ProfileService/api/#profilelistentohopready)).
If implemented correctly, ProfileService will load profiles as fast as the Roblox API allows
it when the player joins a server without a server hop. It&#39;s recommended to release profiles right before universe teleports
to speed up session lock releasing and further preventing time penalties related to server hopping as much as possible.
If your profiles load slower than 7 seconds on a constant basis, continue reading this topic.
</code></pre></div>
</div>
<p><strong>MAKE SURE YOUR <a href="/ProfileService/tutorial/settingup/">ProfileService</a> MODULE IS UP TO DATE</strong></p>
<p>Just to be clear, ProfileService <strong>is not</strong> a module that trades in speed for security - if implemented properly, your profiles must usually load within 1 to 2 seconds - that's how long a single <a href="https://developer.roblox.com/en-us/api-reference/function/GlobalDataStore/UpdateAsync">DataStore UpdateAsync</a> call will take.</p>
<p><strong>The problem</strong></p>
<p>More often than not, <a href="/ProfileService/api/#profilestoreloadprofileasync">ProfileStore:LoadProfileAsync()</a> is taking a clearly longer than usual amount of time to load, usually 7 seconds or much more.</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">tick</span><span class="p">()</span>
<span class="n">ProfileStore</span><span class="p">:</span><span class="n">LoadProfileAsync</span><span class="p">(</span><span class="n">profile_key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tick</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="c1">--&gt; A value over 10 seconds</span>
</code></pre></div>
<p><strong>The culprit</strong></p>
<ul>
<li><em>Is your code <strong>really</strong> releasing your profiles after it's done working with them?</em></li>
<li><em>Are you releasing your profiles <strong>immediately</strong> after the player leaves the game?</em></li>
<li><em>If teleporting between places in your game (universe), are you using <a href="/ProfileService/api/#profilelistentohopready">Profile:ListenToHopReady()</a>?</em></li>
</ul>
<p>Functions connected to <a href="https://developer.roblox.com/en-us/api-reference/event/Players/PlayerRemoving">Players.PlayerRemoving</a>
can be tricky to notice errors for because, when testing alone, you will be leaving the game before the errors appear on the
<a href="https://developer.roblox.com/en-us/articles/Developer-Console">developer console</a>.</p>
<p>If a player hops to another server (<em>Server 2</em>) before the previous one (<em>Server 1</em>) releases (removes session-lock from) the player's <code>Profile</code>,
<em>Server 2</em> will wait until <em>Server 1</em> releases the <code>Profile</code>. ProfileService checks the session-lock state of profiles every 7 seconds during a <a href="/ProfileService/api/#profilestoreloadprofileasync">ProfileStore:LoadProfileAsync()</a> call and this will immediately slow down <code>Profile</code> loading very noticably. This is what we would call a <strong>race condition</strong>.</p>
<p><strong>Mistake example #1:</strong>
<div class="highlight"><pre><span></span><code><span class="n">Players</span><span class="p">.</span><span class="n">PlayerRemoving</span><span class="p">:</span><span class="n">Connect</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">Profiles</span><span class="p">[</span><span class="n">player</span><span class="p">]</span>
    <span class="kr">if</span> <span class="n">profile</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
        <span class="n">progile</span><span class="p">:</span><span class="n">Release</span><span class="p">()</span> <span class="c1">-- &quot;progile&quot; IS A TYPO!</span>
    <span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>
This example would throw an error, though you would need to be inside the server while another player triggers the <code>.PlayerRemoving</code> event.</p>
<p><strong>Mistake example #2:</strong>
<div class="highlight"><pre><span></span><code><span class="n">Players</span><span class="p">.</span><span class="n">PlayerRemoving</span><span class="p">:</span><span class="n">Connect</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">Profiles</span><span class="p">[</span><span class="n">player</span><span class="p">]</span>
    <span class="kr">if</span> <span class="n">profile</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
        <span class="n">SaveData</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span> <span class="c1">-- Are you sure this function doesn&#39;t error?</span>
        <span class="n">profile</span><span class="p">:</span><span class="n">Release</span><span class="p">()</span>
    <span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>
When you're pretty sure you didn't make any typos, the next thing you should check is that nothing can error inside the function connected to <code>.PlayerRemoving</code>.  </p>
<blockquote>
<p>Disclaimer: I don't advise modifying <code>Profile.Data</code> after the player leaves - it's a bad practice in securing your data. You should always store data in a way where unexpectedly losing access to writing to <code>Profile.Data</code> (e.g. server crash) would not cause massive data loss.</p>
</blockquote>
<p><strong>Mistake example #3:</strong>
<div class="highlight"><pre><span></span><code><span class="n">Players</span><span class="p">.</span><span class="n">PlayerRemoving</span><span class="p">:</span><span class="n">Connect</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">Profiles</span><span class="p">[</span><span class="n">player</span><span class="p">]</span>
    <span class="kr">if</span> <span class="n">profile</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
        <span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">-- Or any function with &quot;Wait&quot;, &quot;Async&quot; or &quot;Yield&quot; in its name</span>
        <span class="n">profile</span><span class="p">:</span><span class="n">Release</span><span class="p">()</span>
    <span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>
You should <strong>immediately</strong> release your profiles after the player leaves (<code>wait(1)</code> is bad in this example), otherwise you risk creating a race condition where another server that the player joined is trying to load a <code>Profile</code> that hasn't been released yet.</p>
<p><strong>Mistake example #4:</strong>
<div class="highlight"><pre><span></span><code><span class="kd">local</span> <span class="n">profile_key</span><span class="p">,</span> <span class="n">update_handler</span>

<span class="c1">-- This simulates excessive UpdateAsync calls for the same Profile key:</span>
<span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span> <span class="kr">do</span>
    <span class="n">ProfileStore</span><span class="p">:</span><span class="n">GlobalUpdateProfileAsync</span><span class="p">(</span><span class="n">profile_key</span><span class="p">,</span> <span class="n">update_handler</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></div>
Excessive use of <a href="/ProfileService/api/#profilestoreglobalupdateprofileasync">ProfileStore:GlobalUpdateProfileAsync()</a> can lead to dead session locks and event lost
<code>Profile.Data</code> (latter is mostly possible only if the <code>Profile</code> is loaded in the same session as <code>:GlobalUpdateProfileAsync()</code> is called). This is due to a queue
system that executes every write request for the <code>Profile</code> every 7 seconds - if this queue grows larger than the <a href="https://developer.roblox.com/en-us/api-reference/function/DataModel/BindToClose">BindToClose timeout</a> (approx. 30 seconds), some requests in the queue can be lost after the game shuts down.</p>
<p><strong>How to be sure my profiles are being released?</strong>  </p>
<p>Add a <code>print()</code>:
<div class="highlight"><pre><span></span><code><span class="n">Players</span><span class="p">.</span><span class="n">PlayerRemoving</span><span class="p">:</span><span class="n">Connect</span><span class="p">(</span><span class="kr">function</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">Profiles</span><span class="p">[</span><span class="n">player</span><span class="p">]</span>
    <span class="kr">if</span> <span class="n">profile</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
        <span class="n">profile</span><span class="p">:</span><span class="n">Release</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">Name</span> <span class="o">..</span> <span class="s2">&quot;&#39;s profile has been released!&quot;</span><span class="p">)</span>
    <span class="kr">end</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>
If you're having long <code>Profile</code> loading issues, this is the first thing you should do. Check the developer console for the print and any other possible errors.</p>
<p>When <a href="/ProfileService/api/#profilestoreloadprofileasync">ProfileStore:LoadProfileAsync()</a> finishes loading in...</p>
<ul>
<li>less than 2 seconds - <strong><em>You're good!</em></strong></li>
<li>7 to 30 seconds - <strong><em>Most likely a player server hop race condition (Mistake example #3)</em></strong></li>
<li>Over 60 seconds - <strong><em>The previous server is not releasing the profile / Dead session lock (Mistake examples #1, #2 and #4)</em></strong></li>
</ul>
<h2 id="datastore-warnings-caused-by-profileservice">DataStore warnings caused by ProfileService</h2>
<p><img alt="DataStore warning example screenshot" src="../images/DataStoreWarning.png" /></p>
<p><em>"DataStore request was added to queue. If request queue fills, further requests will be dropped.
Try sending fewer requests. Key = XXXXXX"</em></p>
<p><strong>Is this really bad?</strong></p>
<p>If you're only getting one or two warnings every couple of minutes or so, most likely not. Since March 2021 the ProfileService module now uses a custom queue system which greatly reduces Roblox API queue warnings.</p>
<p><strong>What does this warning mean?</strong></p>
<p>As of writing this guide (July 2020), based on a <a href="https://devforum.roblox.com/t/details-on-datastoreservice-for-advanced-developers/175804">DevForum thread</a>, Rapid successive UpdateAsync calls will be throttled by the DataStoreService and added to a queue:</p>
<blockquote>
<p><strong>Throttling queues</strong></p>
<p>Every actual budget type (GetAsync, SetIncrementAsync, GetSortedAsync, OnUpdateAsync, SetIncrementSortedAsync) has its own throttling queue. Each of these five throttling queues has a queue size of <strong>30 throttled requests max</strong>. Throttled requests are added to the queue of the corresponding budget type that it consumes.</p>
</blockquote>
<p><strong>When will you get warnings</strong></p>
<p>Queue warnings can no longer be caused by faulty use of ProfileService as of March 2021 (Go update now you bastard). I expect these warnings to sometimes pop up during game startup or huge lag spikes / mild API outages.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>